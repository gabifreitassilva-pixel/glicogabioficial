<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GlicoGabi V35</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="manifest" href="manifest.json">
    <style>
        :root { --roxo: #7d5fff; --vermelho: #ff4d4d; --verde: #2ecc71; --amarelo: #ffb142; --lilas: #f3f0ff; --cinza: #95a5a6; }
        body { font-family: sans-serif; background: #2d3436; display: flex; justify-content: center; margin: 0; padding: 5px; }
        .app-shell { width: 360px; height: 780px; background: white; border-radius: 40px; overflow: hidden; display: flex; flex-direction: column; border: 8px solid #1e272e; position: relative; }
        .header { background: var(--roxo); color: white; padding: 40px 20px; text-align: center; flex-shrink: 0; }
        .header i { font-size: 45px; margin-bottom: 12px; }
        .header h1 { margin: 0; font-size: 32px; font-weight: bold; }
        .header p { margin: 8px 0 0; font-size: 16px; opacity: 0.9; }
        .tab-content { flex-grow: 1; overflow-y: auto; display: none; padding-bottom: 100px; }
        .tab-active { display: block; }
        .med-section { padding: 15px; display: flex; justify-content: space-around; gap: 8px; }
        .med-card { border: 1px solid #eee; border-radius: 15px; padding: 10px; flex: 1; text-align: center; font-size: 11px; background: white; }
        .med-card i { color: var(--roxo); display: block; margin-bottom: 5px; font-size: 20px; }
        .input-box { background: var(--lilas); margin: 0 15px 15px; padding: 20px; border-radius: 25px; display: flex; flex-direction: column; align-items: center; }
        input, select { width: 100%; max-width: 280px; border: 1px solid #ddd; padding: 12px; margin-bottom: 12px; border-radius: 12px; font-size: 14px; box-sizing: border-box; }
        .btn-save { background: var(--roxo); color: white; border: none; padding: 15px; border-radius: 15px; width: 100%; max-width: 280px; font-weight: bold; cursor: pointer; }
        .card { border: 1px solid #efefef; border-radius: 18px; padding: 18px; margin: 10px 15px; box-shadow: 0 3px 10px rgba(0,0,0,0.03); position: relative; }
        .val-num { font-size: 24px; font-weight: bold; }
        .ev-row { font-size: 11px; border-top: 1px dashed #eee; padding: 8px 0; display: flex; flex-direction: column; position: relative; }
        .actions-btn { position: absolute; top: 10px; right: 10px; display: flex; gap: 8px; }
        .btn-icon { border: none; background: none; cursor: pointer; font-size: 14px; opacity: 0.7; }
        .config-group { padding: 0 20px; }
        .config-label { font-size: 12px; font-weight: bold; color: var(--roxo); margin-top: 10px; display: block; }
        .time-row { display: flex; gap: 5px; margin-bottom: 10px; }
        .nav { height: 70px; border-top: 1px solid #eee; display: flex; justify-content: space-around; align-items: center; background: rgba(255, 255, 255, 0.95); position: absolute; bottom: 0; left: 0; width: 100%; z-index: 1000; }
        .nav-btn { color: #ccc; font-size: 11px; text-align: center; cursor: pointer; flex: 1; }
        .nav-btn.active { color: var(--roxo); }
        #report-screen { padding: 15px; font-size: 9px; background: white; overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; }
        th, td { border: 1px solid #ccc; padding: 5px; text-align: center; }
    </style>
</head>
<body>

<div class="app-shell">
    <div id="home" class="tab-content tab-active">
        <div class="header">
            <i class="fas fa-heart-pulse"></i>
            <h1>GlicoGabi</h1>
            <p>Ol√°, Gabriela! Vamos cuidar da sa√∫de?</p>
        </div>
        <div class="med-section">
            <div class="med-card"><span>NPH</span><br><b id="v1">--</b></div>
            <div class="med-card"><span>Regular</span><br><b id="v2">--</b></div>
            <div class="med-card"><span>Metf.</span><br><b id="v3">--</b></div>
        </div>
        <div class="input-box">
            <select id="momento">
                <option value="Jejum">üåÖ Jejum</option>
                <option value="P√≥s-Caf√©">‚òï P√≥s-Caf√©</option>
                <option value="Antes Almo√ßo">ü•ó Antes Almo√ßo</option>
                <option value="P√≥s-Almo√ßo">üç± P√≥s-Almo√ßo</option>
                <option value="Antes Jantar">üçó Antes Jantar</option>
                <option value="P√≥s-Jantar">üçï P√≥s-Jantar</option>
            </select>
            <input type="number" id="valor" placeholder="mg/dL">
            <button class="btn-save" onclick="salvarGlicemia()">Salvar Registro</button>
        </div>
        <div id="lista-hoje"></div>
    </div>

    <div id="evolucao" class="tab-content">
        <div class="header" style="padding:20px"><h1>Hist√≥rico</h1></div>
        <div style="padding:15px"><button class="btn-save" onclick="addMarco()">+ Adicionar Marco</button></div>
        <div id="lista-marcos"></div>
    </div>

    <div id="ajustes" class="tab-content">
        <div class="header" style="padding:20px"><h1>Ajustes</h1></div>
        <div class="config-group">
            <button class="btn-save" style="background:#f39c12; margin-bottom:15px" onclick="ativarNotificacoes()">üîî Ativar Alertas no Celular</button>
            
            <span class="config-label">Doses Atuais:</span>
            <div class="time-row"><input id="en" placeholder="NPH" oninput="sinc()"><input id="er" placeholder="Regular" oninput="sinc()"><input id="em" placeholder="Metf." oninput="sinc()"></div>
            <div class="time-row"><input id="vn" placeholder="un" oninput="sinc()"><input id="vr" placeholder="un" oninput="sinc()"><input id="vm" placeholder="mg" oninput="sinc()"></div>
            
            <span class="config-label">Hor√°rios Insulina:</span>
            <div class="time-row"><input type="time" class="h-lembrete" onchange="salvarLembretes()"><input type="time" class="h-lembrete" onchange="salvarLembretes()"><input type="time" class="h-lembrete" onchange="salvarLembretes()"></div>
            <span class="config-label">Hor√°rios Rem√©dios:</span>
            <div class="time-row"><input type="time" class="h-lembrete" onchange="salvarLembretes()"><input type="time" class="h-lembrete" onchange="salvarLembretes()"><input type="time" class="h-lembrete" onchange="salvarLembretes()"></div>
        </div>
    </div>

    <div class="nav">
        <div class="nav-btn active" onclick="aba('home', this)"><i class="fas fa-home"></i><br>Home</div>
        <div class="nav-btn" onclick="aba('evolucao', this)"><i class="fas fa-history"></i><br>Hist√≥rico</div>
        <div class="nav-btn" onclick="aba('ajustes', this)"><i class="fas fa-cog"></i><br>Ajustes</div>
    </div>
</div>

<script>
    let registros = {}; let marcos = []; let lembretes = [];

    window.onload = function() {
        const d = localStorage.getItem('glicogabi-v35'); if(d) registros = JSON.parse(d);
        const m = localStorage.getItem('glicogabi-marcos'); if(m) marcos = JSON.parse(m);
        const l = localStorage.getItem('glicogabi-lembretes'); if(l) {
            lembretes = JSON.parse(l);
            const inputs = document.querySelectorAll('.h-lembrete');
            lembretes.forEach((hora, i) => { if(inputs[i]) inputs[i].value = hora; });
        }
        ['en','er','em','vn','vr','vm'].forEach(id => {
            const val = localStorage.getItem('glicogabi-'+id); if(val) document.getElementById(id).value = val;
        });
        sinc(); renderHome(); 
        
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('sw.js').then(() => {
                console.log("Sistema de Alerta Ativo");
                setInterval(verificarLembretes, 60000);
            });
        }
    };

    function ativarNotificacoes() { 
        Notification.requestPermission().then(p => { if(p === "granted") alert("Alertas ativados!"); });
    }

    function salvarLembretes() {
        const inputs = document.querySelectorAll('.h-lembrete');
        lembretes = Array.from(inputs).map(i => i.value);
        localStorage.setItem('glicogabi-lembretes', JSON.stringify(lembretes));
    }

    function verificarLembretes() {
        const agora = new Date().toLocaleTimeString('pt-BR', {hour: '2-digit', minute: '2-digit'});
        const inputs = document.querySelectorAll('.h-lembrete');
        const horasInsulina = [inputs[0].value, inputs[1].value, inputs[2].value];
        const horasRemedios = [inputs[3].value, inputs[4].value, inputs[5].value];

        let titulo = ""; let msg = "";

        if (horasInsulina.includes(agora)) {
            titulo = "‚ö†Ô∏è HORA DA INSULINA";
            msg = "Est√° na hora da sua dose. Voc√™ j√° aplicou?";
        } else if (horasRemedios.includes(agora)) {
            titulo = "üíä HORA DO REM√âDIO";
            msg = "Est√° na hora da sua medica√ß√£o oral. J√° tomou?";
        }

        if (titulo !== "" && 'serviceWorker' in navigator && Notification.permission === "granted") {
            navigator.serviceWorker.ready.then(reg => {
                reg.active.postMessage({ type: 'DISPARAR_ALARME', title: titulo, body: msg });
            });
        }
    }

    function aba(id, el) {
        document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('tab-active'));
        document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(id).classList.add('tab-active');
        el.classList.add('active');
    }

    function sinc() {
        ['en','er','em','vn','vr','vm'].forEach(id => localStorage.setItem('glicogabi-'+id, document.getElementById(id).value));
        document.getElementById('v1').innerText = (document.getElementById('vn').value || "--") + "un";
        document.getElementById('v2').innerText = (document.getElementById('vr').value || "--") + "un";
        document.getElementById('v3').innerText = (document.getElementById('vm').value || "--") + "mg";
    }

    function salvarGlicemia() {
        const v = parseInt(document.getElementById('valor').value);
        const m = document.getElementById('momento').value;
        const hoje = new Date().toLocaleDateString('pt-BR');
        if(!v) return;
        if(!registros[hoje]) registros[hoje] = {};
        let cor = (v < 70 || v > 250) ? "#ff4d4d" : (v > 140 ? "#ffb142" : "#2ecc71");
        registros[hoje][m] = { v, h: new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}), c: cor, evs: [] };
        localStorage.setItem('glicogabi-v35', JSON.stringify(registros));
        renderHome(); document.getElementById('valor').value = "";
    }

    function renderHome() {
        const l = document.getElementById('lista-hoje'); l.innerHTML = "";
        const hoje = new Date().toLocaleDateString('pt-BR');
        if(!registros[hoje]) return;
        for(let m in registros[hoje]) {
            let c = registros[hoje][m];
            l.innerHTML += `<div class="card"><b>${m}</b><br><small>${hoje} - ${c.h}</small><div class="val-num" style="color:${c.c}">${c.v} mg/dL</div></div>`;
        }
    }
</script>
</body>
</html>
